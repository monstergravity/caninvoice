    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title data-i18n="app_title">è´´ç¥¨å°åŠ©æ‰‹</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
        <style>
            :root {
                --primary-color: #2563EB; /* Blue-600 */
            }
            body {
                font-family: 'Inter', sans-serif;
                background-color: #f7f9fb;
            }
            /* Custom styling for the voucher elements and canvas area */
            .canvas-container {
                min-height: 85vh;
                background-color: #ffffff;
                /* å…è®¸å‚ç›´æ»šåŠ¨ */
                overflow-y: auto; 
                overflow-x: hidden;
                border: 1px solid #e5e7eb; 
                user-select: none;
                position: relative;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
                transition: width 0.3s;
            }
            .voucher {
                position: absolute;
                width: 160px;
                height: 90px;
                cursor: pointer;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 8px;
                font-size: 10px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                transition: box-shadow 0.1s, background-color 0.3s;
                touch-action: none; 
                border-radius: 0.5rem;
            }
            .voucher:active, .voucher.selected {
                cursor: grabbing;
                box-shadow: 0 0 0 3px var(--primary-color);
                z-index: 100;
            }
            .control-button {
                transition: all 0.15s ease-in-out;
            }
            .control-button:hover {
                transform: translateY(-1px);
            }
            
            .message-box {
                position: fixed;
                top: 1rem;
                right: 1rem;
                z-index: 200;
            }

            /* ç¥¨æ®ç±»å‹é¢œè‰²é«˜äº® */
            .voucher.type-traffic { background-color: #dbeafe; border: 1px solid #93c5fd; } /* Blue (äº¤é€šè´¹) */
            .voucher.type-dining { background-color: #fce7f3; border: 1px solid #f9a8d4; } /* Pink (é¤è´¹) */
            .voucher.type-accommodation { background-color: #d1fae5; border: 1px solid #6ee7b7; } /* Green (ä½å®¿è´¹) */
            .voucher.type-office { background-color: #e0f2fe; border: 1px solid #7dd3fc; } /* Light Blue (åŠå…¬ç”¨å“) */
            .voucher.type-other { background-color: #fef3c7; border: 1px solid #fcd34d; } /* Yellow (å…¶ä»–) */
            
            /* ä¾§è¾¹æ æ ·å¼ */
            #sidebar {
                width: 0; 
                opacity: 0;
                overflow: hidden;
                transition: all 0.3s ease-in-out;
            }
            #sidebar.open {
                width: 300px;
                opacity: 1;
                padding-left: 1rem;
            }

            /* Loading Spinner */
            .spinner {
                border: 4px solid rgba(0, 0, 0, 0.1);
                border-top: 4px solid white;
                border-radius: 50%;
                width: 1rem;
                height: 1rem;
                animation: spin 1s linear infinite;
                margin-right: 0.5rem;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* ä¿è¯åœ¨å°å±å¹•ä¸Šä¾§è¾¹æ å †å  */
            @media (max-width: 768px) {
                #main-content-wrapper {
                    flex-direction: column;
                }
                #sidebar.open {
                    width: 100%;
                    padding-left: 0;
                    margin-top: 1rem;
                }
            }
        </style>
    </head>
    <body class="p-4 md:p-8">

        <!-- æ ‡é¢˜å’Œæ ¸å¿ƒä»·å€¼ -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800" data-i18n="app_title">è´´ç¥¨å°åŠ©æ‰‹</h1>
            <p class="text-lg text-gray-600 mt-1" data-i18n="app_subtitle">3åˆ†é’Ÿå®Œæˆè´´ç¥¨æ•´ç†ï¼Œå‘Šåˆ«æŠ¥é”€å‰çš„å‡†å¤‡å·¥ä½œçƒ¦æ¼</p>
            
            <!-- è¯­è¨€å’Œè´§å¸é€‰æ‹©å™¨ -->
            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
                <!-- è¯­è¨€é€‰æ‹©å™¨ -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-700">Language:</span>
                    <select id="language-select" class="border border-gray-300 rounded-lg py-1 px-3 focus:ring-blue-500 focus:border-blue-500">
                        <option value="zh">ç®€ä½“ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="ko">í•œêµ­ì–´</option>
                    </select>
                </div>

                <!-- è´§å¸é€‰æ‹©å™¨ -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-700" data-i18n="label_currency">è´§å¸:</span>
                    <select id="currency-select" class="border border-gray-300 rounded-lg py-1 px-3 focus:ring-blue-500 focus:border-blue-500">
                        <option value="CNY">Â¥ CNY (äººæ°‘å¸)</option>
                        <option value="USD">$ USD (ç¾å…ƒ)</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- ä¸»æ“ä½œåŒº -->
        <div class="max-w-7xl mx-auto">
            
            <!-- é¡¶éƒ¨æ§åˆ¶é¢æ¿ -->
            <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 mb-4 rounded-lg shadow-md border border-gray-100">
                <div class="flex space-x-3 mb-4 md:mb-0">
                    
                    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
                    <input type="file" id="file-upload" accept="image/*" class="hidden">
                    <button id="upload-btn" class="control-button bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg flex items-center" data-i18n="btn_upload">
                        ğŸ“¸ æ‹ç…§/ä¸Šä¼ ç¥¨æ®
                    </button>

                    <button id="align-btn" class="control-button bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg" data-i18n="btn_align">
                        ğŸ¤– æ™ºèƒ½å¸é™„/å¯¹é½
                    </button>
                </div>
                
                <div class="flex space-x-3 items-center">
                    <span class="text-gray-700 font-medium" data-i18n="label_layout_mode">æ’ç‰ˆæ¨¡å¼:</span>
                    <select id="layout-mode-select" class="control-button border border-gray-300 rounded-full py-2 px-4 focus:ring-blue-500 focus:border-blue-500">
                        <option value="A4" data-i18n="layout_a4">A4 æ ‡å‡†æ¨¡æ¿ (è‡ªç”±)</option>
                        <option value="DateGroup" data-i18n="layout_date_group">æŒ‰æ—¶é—´åˆ†ç»„ (æ™ºèƒ½æ•´ç†)</option>
                        <option value="CategoryGroup" data-i18n="layout_category_group">æŒ‰ç±»åˆ«åˆ†ç»„ (æ™ºèƒ½æ•´ç†)</option>
                    </select>
                    <button id="export-btn" class="control-button bg-primary-color hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full shadow-lg" data-i18n="btn_export">
                        ğŸ“¥ å¯¼å‡ºæ‰“å°ä¼˜åŒ–ç‰ˆ PDF (æ¨¡æ‹Ÿ)
                    </button>
                </div>
            </div>

            <!-- Canvas ç”»å¸ƒåŒºåŸŸä¸ä¾§è¾¹æ å®¹å™¨ -->
            <div id="main-content-wrapper" class="flex flex-col md:flex-row w-full gap-4">
                <!-- Canvas ç”»å¸ƒåŒºåŸŸ -->
                <div id="canvas-area" class="canvas-container rounded-xl flex-grow">
                    <!-- ç¥¨æ®å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    <div class="absolute inset-0 flex items-center justify-center text-gray-400 pointer-events-none">
                        <span id="canvas-hint" class="text-2xl" data-i18n="canvas_hint">å°†ç¥¨æ®æ‹–æ‹½åˆ°æ­¤å¤„ï¼Œå¼€å§‹è‡ªç”±æ’ç‰ˆ...</span>
                    </div>
                </div>

                <!-- å³ä¾§ç¥¨æ®è¯¦æƒ…ä¾§è¾¹æ  -->
                <div id="sidebar" class="bg-white rounded-xl shadow-lg border border-gray-100 flex-shrink-0">
                    <div class="p-4 flex flex-col h-full">
                        <div class="flex justify-between items-center pb-3 border-b mb-3">
                            <h3 class="text-lg font-bold text-gray-800" data-i18n="sidebar_title">ğŸ§¾ ç¥¨æ®è¯¦æƒ…</h3>
                            <button id="close-sidebar-btn" class="text-gray-500 hover:text-gray-900 font-bold text-xl leading-none">&times;</button>
                        </div>

                        <!-- è¯¦æƒ…å†…å®¹åŒº -->
                        <div id="voucher-details-content" class="space-y-4 overflow-y-auto">
                            <p class="text-gray-500 text-center pt-8" data-i18n="sidebar_hint">è¯·ç‚¹å‡»ç”»å¸ƒä¸­çš„ä»»ä¸€ç¥¨æ®æŸ¥çœ‹è¯¦æƒ…ã€‚</p>
                            <!-- è¯¦æƒ…æ•°æ®å°†é€šè¿‡ JS å¡«å…… -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æç¤ºæ¡† -->
        <div id="message-box" class="message-box"></div>

    <script>
        // --- API & Auth Configuration ---
        const API_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;
        
        // è´¹ç”¨ç±»åˆ«æ˜ å°„è¡¨
        const CATEGORY_MAP = {
            'traffic': { zh: 'äº¤é€šè´¹', en: 'Traffic', ko: 'êµí†µë¹„', color: 'type-traffic' },
            'dining': { zh: 'é¤è´¹', en: 'Dining', ko: 'ì‹ì‚¬ë¹„', color: 'type-dining' },
            'accommodation': { zh: 'ä½å®¿è´¹', en: 'Accommodation', ko: 'ìˆ™ë°•ë¹„', color: 'type-accommodation' },
            'office': { zh: 'åŠå…¬ç”¨å“', en: 'Office Supply', ko: 'ì‚¬ë¬´ìš©í’ˆ', color: 'type-office' },
            'other': { zh: 'å…¶ä»–', en: 'Other', ko: 'ê¸°íƒ€', color: 'type-other' },
        };

        // --- è´§å¸è®¾ç½® ---
        const CURRENCY_SYMBOLS = {
            'CNY': 'Â¥',
            'USD': '$',
        };
        let currentCurrency = 'CNY';
        let currentCurrencySymbol = CURRENCY_SYMBOLS[currentCurrency];


        // --- å›½é™…åŒ–/è¯­è¨€æ”¯æŒ ---
        const translations = {
            // ... (ä¿æŒä¸å˜ï¼Œæˆ–ç¡®ä¿ OCR æ¶ˆæ¯å·²æ›´æ–°)
            // --- App & General ---
            app_title: {
                zh: 'è´´ç¥¨å°åŠ©æ‰‹',
                en: 'Caninvoice',
                ko: 'Caninvoice'
            },
            app_subtitle: {
                zh: '3åˆ†é’Ÿå®Œæˆè´´ç¥¨æ•´ç†ï¼Œå‘Šåˆ«æŠ¥é”€å‰çš„å‡†å¤‡å·¥ä½œçƒ¦æ¼',
                en: 'Complete voucher arrangement in 3 minutes, say goodbye to pre-reimbursement hassles.',
                ko: '3ë¶„ ë§Œì— ì˜ìˆ˜ì¦ ì •ë¦¬ ì™„ë£Œ, í™˜ê¸‰ ì „ ì¤€ë¹„ ê±±ì • ë'
            },
            label_currency: {
                zh: 'è´§å¸:',
                en: 'Currency:',
                ko: 'í†µí™”:'
            },
            btn_upload: {
                zh: 'ğŸ“¸ æ‹ç…§/ä¸Šä¼ ç¥¨æ®',
                en: 'ğŸ“¸ Capture/Upload Voucher',
                ko: 'ğŸ“¸ ì˜ìˆ˜ì¦ ì´¬ì˜/ì—…ë¡œë“œ'
            },
            btn_align: {
                zh: 'ğŸ¤– æ™ºèƒ½å¸é™„/å¯¹é½',
                en: 'ğŸ¤– Smart Snap/Align',
                ko: 'ğŸ¤– ìŠ¤ë§ˆíŠ¸ ì •ë ¬/ë°°ì¹˜'
            },
            label_layout_mode: {
                zh: 'æ’ç‰ˆæ¨¡å¼:',
                en: 'Layout Mode:',
                ko: 'ë°°ì¹˜ ëª¨ë“œ:'
            },
            layout_a4: {
                zh: 'A4 æ ‡å‡†æ¨¡æ¿ (è‡ªç”±)',
                en: 'A4 Standard Template (Free)',
                ko: 'A4 í‘œì¤€ í…œí”Œë¦¿ (ììœ )'
            },
            layout_date_group: {
                zh: 'æŒ‰æ—¶é—´åˆ†ç»„ (æ™ºèƒ½æ•´ç†)',
                en: 'Group by Date (Smart Arrange)',
                ko: 'ë‚ ì§œë³„ ê·¸ë£¹ (ìŠ¤ë§ˆíŠ¸ ì •ë¦¬)'
            },
            layout_category_group: {
                zh: 'æŒ‰ç±»åˆ«åˆ†ç»„ (æ™ºèƒ½æ•´ç†)',
                en: 'Group by Category (Smart Arrange)',
                ko: 'ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹ (ìŠ¤ë§ˆíŠ¸ ì •ë¦¬)'
            },
            btn_export: {
                zh: 'ğŸ“¥ å¯¼å‡ºæ‰“å°ä¼˜åŒ–ç‰ˆ PDF (æ¨¡æ‹Ÿ)',
                en: 'ğŸ“¥ Export Print Optimized PDF (Mock)',
                ko: 'ğŸ“¥ ì¸ì‡„ ìµœì í™” PDF ë‚´ë³´ë‚´ê¸° (ëª¨ì˜)'
            },
            canvas_hint: {
                zh: 'å°†ç¥¨æ®æ‹–æ‹½åˆ°æ­¤å¤„ï¼Œå¼€å§‹è‡ªç”±æ’ç‰ˆ...',
                en: 'Drag vouchers here to start free arrangement...',
                ko: 'ì—¬ê¸°ë¡œ ì˜ìˆ˜ì¦ì„ ë“œë˜ê·¸í•˜ì—¬ ììœ ë¡­ê²Œ ë°°ì¹˜í•˜ì„¸ìš”...'
            },
            sidebar_title: {
                zh: 'ğŸ§¾ ç¥¨æ®è¯¦æƒ…',
                en: 'ğŸ§¾ Voucher Details',
                ko: 'ğŸ§¾ ì˜ìˆ˜ì¦ ì„¸ë¶€ ì •ë³´'
            },
            sidebar_hint: {
                zh: 'è¯·ç‚¹å‡»ç”»å¸ƒä¸­çš„ä»»ä¸€ç¥¨æ®æŸ¥çœ‹è¯¦æƒ…ã€‚',
                en: 'Please click any voucher on the canvas to view details.',
                ko: 'ìº”ë²„ìŠ¤ì—ì„œ ì˜ìˆ˜ì¦ì„ í´ë¦­í•˜ì—¬ ì„¸ë¶€ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.'
            },

            // --- Details Pane ---
            detail_amount: {
                zh: 'æ€»é‡‘é¢:',
                en: 'Total Amount:',
                ko: 'ì´ ê¸ˆì•¡:'
            },
            detail_type: {
                zh: 'è¯†åˆ«ç±»å‹:',
                en: 'Recognized Type:',
                ko: 'ì¸ì‹ëœ ìœ í˜•:'
            },
            detail_date: {
                zh: 'äº¤æ˜“æ—¥æœŸ:',
                en: 'Transaction Date:',
                ko: 'ê±°ë˜ ë‚ ì§œ:'
            },
            detail_summary: {
                zh: 'å‘ç¥¨æ‘˜è¦:',
                en: 'Voucher Summary:',
                ko: 'ì˜ìˆ˜ì¦ ìš”ì•½:'
            },
            detail_issuer: {
                zh: 'å¼€ç¥¨æ–¹:',
                en: 'Issuer:',
                ko: 'ë°œí–‰ì²˜:'
            },
            detail_tax: {
                zh: 'ç¨é¢:',
                en: 'Tax Amount:',
                ko: 'ì„¸ì•¡:'
            },
            btn_remove: {
                zh: 'âŒ ç§»é™¤ç¥¨æ®',
                en: 'âŒ Remove Voucher',
                ko: 'âŒ ì˜ìˆ˜ì¦ ì œê±°'
            },
            
            // --- Dynamic Messages ---
            msg_voucher: { zh: 'ç¥¨æ®', en: 'Voucher', ko: 'ì˜ìˆ˜ì¦' },
            msg_rotated: { zh: 'å·²æ—‹è½¬', en: 'rotated', ko: 'íšŒì „ë¨' },
            msg_upload_start: { zh: 'ğŸ“¤ æ­£åœ¨ä¸Šä¼ å¹¶å¯åŠ¨æ™ºèƒ½ OCR è¯†åˆ«...', en: 'ğŸ“¤ Uploading and starting Smart OCR recognition...', ko: 'ğŸ“¤ ì—…ë¡œë“œ ë° ìŠ¤ë§ˆíŠ¸ OCR ì¸ì‹ ì‹œì‘ ì¤‘...' },
            msg_upload_success: { 
                zh: (id, amount, type) => `âœ… ç¥¨æ® #${id} è¯†åˆ«æˆåŠŸå¹¶æ·»åŠ è‡³ç”»å¸ƒ! (${currentCurrencySymbol}${amount} - ${type})`, 
                en: (id, amount, type) => `âœ… Voucher #${id} successfully recognized and added! (${currentCurrencySymbol}${amount} - ${type})`, 
                ko: (id, amount, type) => `âœ… ì˜ìˆ˜ì¦ #${id} ì¸ì‹ ì„±ê³µ ë° ìº”ë²„ìŠ¤ì— ì¶”ê°€ë¨! (${currentCurrencySymbol}${amount} - ${type})` 
            },
            msg_upload_fail: {
                zh: (err) => `âŒ OCR è¯†åˆ«å¤±è´¥: ${err}`,
                en: (err) => `âŒ OCR recognition failed: ${err}`,
                ko: (err) => `âŒ OCR ì¸ì‹ ì‹¤íŒ¨: ${err}`
            },
            msg_no_vouchers: {
                zh: 'ç”»å¸ƒä¸Šæ²¡æœ‰ç¥¨æ®éœ€è¦å¯¹é½ã€‚',
                en: 'There are no vouchers on the canvas to align.',
                ko: 'ì •ë ¬í•  ì˜ìˆ˜ì¦ì´ ìº”ë²„ìŠ¤ì— ì—†ìŠµë‹ˆë‹¤.'
            },
            msg_align_date: {
                zh: 'ğŸ¤– å·²æŒ‰ã€æ—¶é—´ã€‘åˆ†ç»„æ’ç‰ˆã€‚',
                en: 'ğŸ¤– Arranged by [Date] Grouping.',
                ko: 'ğŸ¤– [ë‚ ì§œ] ê·¸ë£¹ë³„ë¡œ ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.'
            },
            msg_align_category: {
                zh: 'ğŸ¤– å·²æŒ‰ã€ç±»åˆ«ã€‘åˆ†ç»„æ’ç‰ˆã€‚',
                en: 'ğŸ¤– Arranged by [Category] Grouping.',
                ko: 'ğŸ¤– [ì¹´í…Œê³ ë¦¬] ê·¸ë£¹ë³„ë¡œ ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.'
            },
            msg_align_a4: {
                zh: 'ğŸ¤– æ™ºèƒ½å¸é™„/å¯¹é½æ¿€æ´» (A4æ ‡å‡†æ¨¡å¼)ã€‚',
                en: 'ğŸ¤– Smart Snap/Align activated (A4 Standard Mode).',
                ko: 'ğŸ¤– ìŠ¤ë§ˆíŠ¸ ì •ë ¬/ë°°ì¹˜ í™œì„±í™” (A4 í‘œì¤€ ëª¨ë“œ).'
            },
            msg_export_error: {
                zh: 'è¯·å…ˆæ·»åŠ ç¥¨æ®å†å¯¼å‡ºã€‚',
                en: 'Please add vouchers before exporting.',
                ko: 'ë‚´ë³´ë‚´ê¸° ì „ì— ì˜ìˆ˜ì¦ì„ ì¶”ê°€í•˜ì„¸ìš”.'
            },
            msg_export_in_progress: {
                zh: (count) => `ğŸ“¥ æ­£åœ¨ä½¿ç”¨ç¦»å± Canvas å¿«é€Ÿç”Ÿæˆ ${count} å¼ ç¥¨æ®çš„ PDF...`,
                en: (count) => `ğŸ“¥ Generating PDF for ${count} vouchers using off-screen Canvas...`,
                ko: 'ğŸ“¥ ì˜¤í”„ìŠ¤í¬ë¦° ìº”ë²„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ìˆ˜ì¦ ìƒì„± ì¤‘...'
            },
            msg_export_success: {
                zh: 'âœ… PDF (æ‰“å°ä¼˜åŒ–ç‰ˆ) ç”Ÿæˆå¹¶å·²ä¸‹è½½åˆ°æ‚¨çš„è®¾å¤‡ã€‚',
                en: 'âœ… PDF (Print Optimized) generated and downloaded to your device.',
                ko: 'âœ… PDF (ì¸ì‡„ ìµœì í™”)ê°€ ìƒì„±ë˜ì–´ ì¥ì¹˜ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.'
            },
            msg_welcome: {
                zh: 'æ¬¢è¿ä½¿ç”¨è´´ç¥¨æ•´ç†åŠ©æ‰‹ï¼å·²ä¸ºæ‚¨åŠ è½½ 20 å¼ æ¨¡æ‹Ÿ OCR ç¥¨æ®ã€‚è¯·ç‚¹å‡» "æ‹ç…§/ä¸Šä¼ ç¥¨æ®" ä½“éªŒ OCR åŠŸèƒ½ã€‚',
                en: 'Welcome to the Voucher Arrangement Assistant! 20 mock OCR vouchers have been loaded. Click "Capture/Upload Voucher" to try the OCR feature.',
                ko: 'ì˜ìˆ˜ì¦ ì •ë¦¬ ë„ìš°ë¯¸ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! 20ê°œì˜ ëª¨ì˜ OCR ì˜ìˆ˜ì¦ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. "ì˜ìˆ˜ì¦ ì´¬ì˜/ì—…ë¡œë“œ"ë¥¼ í´ë¦­í•˜ì—¬ OCR ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ë³´ì„¸ìš”.'
            }
        };

        let currentLanguage = 'zh'; // é»˜è®¤ä¸­æ–‡

        function getI18nText(key, ...args) {
            const text = translations[key] ? translations[key][currentLanguage] : key;
            if (typeof text === 'function') {
                return text(...args);
            }
            return text || key;
        }

        // æ›´æ–°æ‰€æœ‰ç¥¨æ®å’Œä¾§è¾¹æ çš„æ˜¾ç¤ºè´§å¸/è¯­è¨€
        function updateVoucherDisplays() {
            const vouchers = document.querySelectorAll('.voucher');
            vouchers.forEach(voucher => {
                const data = voucher.dataset;
                const amount = parseFloat(data.amount);
                
                // è·å–å½“å‰è¯­è¨€çš„ç±»å‹åç§°
                const typeInCurrentLang = data['type_' + currentLanguage] || data.type;

                // é‡æ–°æ¸²æŸ“ç¥¨æ®ä¸»ä½“å†…å®¹
                voucher.querySelector('.text-xl').innerHTML = `${currentCurrencySymbol}${amount.toFixed(2)}`;
                voucher.querySelector('.text-xs.font-semibold').textContent = typeInCurrentLang;
            });

            // å¦‚æœä¾§è¾¹æ æ‰“å¼€ï¼Œåˆ™åˆ·æ–°è¯¦æƒ…ä»¥æ›´æ–°è´§å¸ç¬¦å·
            const selectedVoucher = document.querySelector('.voucher.selected');
            if (selectedVoucher) {
                showVoucherDetails(selectedVoucher);
            }
        }


        function translateUI(lang) {
            currentLanguage = lang;
            // 1. ç¿»è¯‘é™æ€æ–‡æœ¬
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const translation = getI18nText(key);

                if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    element.placeholder = translation;
                } else if (element.tagName === 'OPTION') {
                    element.textContent = translation;
                } else {
                    element.textContent = translation;
                }
            });
            
            // 2. ç¿»è¯‘åŠ¨æ€/ç‰¹æ®ŠåŒºåŸŸ
            document.querySelector('title').textContent = getI18nText('app_title');
            
            // 3. é‡ç½®ä¾§è¾¹æ æç¤º
            if (!document.querySelector('.voucher.selected')) {
                detailsContent.innerHTML = `<p class="text-gray-500 text-center pt-8">${getI18nText('sidebar_hint')}</p>`;
            }

            // 4. æ›´æ–°æ‰€æœ‰ç¥¨æ®å’Œä¾§è¾¹æ çš„æ˜¾ç¤ºè´§å¸/è¯­è¨€
            updateVoucherDisplays();
        }

        // è¯­è¨€åˆ‡æ¢äº‹ä»¶ç›‘å¬
        const languageSelect = document.getElementById('language-select');
        languageSelect.addEventListener('change', (e) => {
            translateUI(e.target.value);
        });

        // è´§å¸åˆ‡æ¢äº‹ä»¶ç›‘å¬ (NEW)
        const currencySelect = document.getElementById('currency-select');
        currencySelect.addEventListener('change', (e) => {
            currentCurrency = e.target.value;
            currentCurrencySymbol = CURRENCY_SYMBOLS[currentCurrency];
            // åˆ‡æ¢è´§å¸åï¼Œç«‹å³æ›´æ–°æ‰€æœ‰æ˜¾ç¤ºçš„é‡‘é¢
            updateVoucherDisplays(); 
        });


        // --- æ¶ˆæ¯æç¤ºåŠŸèƒ½ ---
        const messageBox = document.getElementById('message-box');
        function showMessage(text, type = 'info', duration = 3000) {
            const color = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 
                        type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 
                        'bg-blue-100 border-blue-400 text-blue-700';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `p-4 rounded-lg border shadow-md mb-2 transition-opacity duration-300 ${color}`;
            alertDiv.textContent = text;
            
            messageBox.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 300);
            }, duration);
        }
        
        // --- è¾…åŠ©å‡½æ•°ï¼šæ–‡ä»¶è½¬ Base64 ---
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove the data URI scheme prefix (e.g., 'data:image/jpeg;base64,')
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
            });
        }

        // --- è¾…åŠ©å‡½æ•°ï¼šå¸¦æŒ‡æ•°é€€é¿çš„ Fetch ---
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                        console.warn(`Rate limit hit, retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API call failed with status ${response.status}: ${errorBody}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    console.warn(`Fetch error, retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // --- ç¥¨æ®æ•°æ®ç»“æ„å’Œç”Ÿæˆ ---
        let voucherCount = 0;
        const canvasArea = document.getElementById('canvas-area');
        const sidebar = document.getElementById('sidebar');
        const detailsContent = document.getElementById('voucher-details-content');
        
        /**
         * å°† OCR è¯†åˆ«ç»“æœæ˜ å°„åˆ°å®Œæ•´çš„ç¥¨æ®æ•°æ®ç»“æ„
         * @param {Object} ocrResult - åŸå§‹ OCR ç»“æœ
         * @returns {Object} å®Œæ•´ç¥¨æ®æ•°æ®
         */
        function mapOcrResultToVoucherData(ocrResult) {
            // ç¡®ä¿ç±»åˆ«æ˜¯æœ‰æ•ˆå€¼ï¼Œå¦åˆ™é»˜è®¤ä¸º 'other'
            const categoryKey = ocrResult.category && CATEGORY_MAP[ocrResult.category.toLowerCase()]
                ? ocrResult.category.toLowerCase()
                : 'other';

            const categoryData = CATEGORY_MAP[categoryKey];
            
            // å°è¯•è§£æé‡‘é¢å’Œç¨é¢ä¸ºæµ®ç‚¹æ•°
            const amount = parseFloat(ocrResult.amount) || 0.00;
            const tax = parseFloat(ocrResult.tax) || 0.00;

            return {
                amount: amount,
                date: ocrResult.date || 'N/A',
                type: categoryData.zh, // ä¸­æ–‡ç±»å‹
                type_en: categoryData.en, // è‹±æ–‡ç±»å‹
                type_ko: categoryData.ko, // éŸ©æ–‡ç±»å‹
                category: categoryKey, // å†…éƒ¨è¯†åˆ«é”®
                desc: ocrResult.desc || 'æœªè¯†åˆ«æ‘˜è¦',
                desc_en: ocrResult.desc || 'Unrecognized summary',
                desc_ko: ocrResult.desc || 'ì¸ì‹ë˜ì§€ ì•Šì€ ìš”ì•½',
                issuer: ocrResult.issuer || 'æœªè¯†åˆ«å¼€ç¥¨æ–¹',
                issuer_en: ocrResult.issuer || 'Unrecognized Issuer',
                issuer_ko: ocrResult.issuer || 'ì¸ì‹ë˜ì§€ ì•Šì€ ë°œí–‰ì²˜',
                tax: tax,
            };
        }

        // åˆå§‹åŠ è½½æ—¶ä½¿ç”¨çš„æ¨¡æ‹Ÿæ•°æ® (ç”¨äºå¿«é€Ÿæ¼”ç¤º)
        const MOCK_VOUCHER_TYPES = [
            mapOcrResultToVoucherData({ amount: 58.50, date: '2025-05-12', category: 'traffic', desc: 'æ»´æ»´å‡ºè¡Œ', issuer: 'æ·±åœ³äº¤é€šé›†å›¢', tax: 5.00 }),
            mapOcrResultToVoucherData({ amount: 120.00, date: '2025-05-15', category: 'dining', desc: 'å•†åŠ¡åˆé¤', issuer: 'å–œèŒ¶ä¸‡è±¡åŸåº—', tax: 10.90 }),
            mapOcrResultToVoucherData({ amount: 25.80, date: '2025-05-18', category: 'office', desc: 'æ‰“å°è€—æ', issuer: 'äº¬ä¸œè‡ªè¥', tax: 2.34 }),
            mapOcrResultToVoucherData({ amount: 1500.00, date: '2025-06-01', category: 'accommodation', desc: 'æ·±åœ³å‡ºå·®', issuer: 'å¸Œå°”é¡¿é…’åº—', tax: 136.36 }),
            mapOcrResultToVoucherData({ amount: 35.00, date: '2025-06-05', category: 'traffic', desc: 'åœ°é“', issuer: 'æ·±åœ³åœ°é“', tax: 0.00 }),
            mapOcrResultToVoucherData({ amount: 80.00, date: '2025-05-12', category: 'dining', desc: 'å·¥ä½œæ™šé¤', issuer: 'æµ·åº•æ', tax: 7.27 }),
            mapOcrResultToVoucherData({ amount: 480.00, date: '2025-06-02', category: 'accommodation', desc: 'é…’åº—', issuer: 'ç»´ä¹Ÿçº³é…’åº—', tax: 43.64 }),
            mapOcrResultToVoucherData({ amount: 10.00, date: '2025-05-13', category: 'other', desc: 'åœè½¦è´¹', issuer: 'ä¸‡è±¡åŸåœè½¦åœº', tax: 0.00 })
        ];


        function createVoucherElement(id, data, x, y, rotation = 0) {
            const categoryClass = CATEGORY_MAP[data.category] ? CATEGORY_MAP[data.category].color : 'type-other';
            const typeInCurrentLang = data['type_' + currentLanguage] || data.type;

            const voucher = document.createElement('div');
            voucher.className = `voucher transform transition-transform duration-300 ${categoryClass}`;
            voucher.id = `voucher-${id}`;
            
            // ç¥¨æ®æ•°æ® (è¯¦ç»†æ¨¡æ‹Ÿ OCR ç»“æœ)
            voucher.innerHTML = `
                <div class="flex justify-between w-full">
                    <span class="text-xs font-semibold text-gray-700">${typeInCurrentLang}</span>
                    <span class="text-xs text-gray-500">${data.date.substring(5)}</span>
                </div>
                <!-- ä½¿ç”¨ currentCurrencySymbol æ›¿æ¢ Â¥ -->
                <div class="text-xl font-extrabold text-gray-800 my-1">${currentCurrencySymbol}${data.amount.toFixed(2)}</div>
                <div class="text-xs text-gray-400 truncate w-full text-center">(${data['desc_' + currentLanguage] || data.desc})</div>
            `;
            
            // åˆå§‹ä½ç½®å’Œæ—‹è½¬
            voucher.style.left = `${x}px`;
            voucher.style.top = `${y}px`;
            voucher.style.transform = `rotate(${rotation}deg)`;
            
            // å­˜å‚¨æ‰€æœ‰æ•°æ®åˆ° dataset
            Object.keys(data).forEach(key => {
                voucher.dataset[key] = String(data[key]); // ç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨ä¸ºå­—ç¬¦ä¸²
            });
            voucher.dataset.id = String(id);
            
            return voucher;
        }

        function addVoucher(data) {
            voucherCount++;
            const id = voucherCount;
            // åˆå§‹ä½ç½®éšæœºæ•£å¼€
            const x = Math.random() * (canvasArea.clientWidth - 160); 
            const y = Math.random() * (canvasArea.clientHeight - 90);
            const rotation = Math.floor(Math.random() * 60) - 30; // -30 to +30 degrees
            
            const voucherElement = createVoucherElement(id, data, x, y, rotation);
            canvasArea.appendChild(voucherElement);
            
            // å¯ç”¨æ‹–æ‹½ã€æ—‹è½¬å’Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
            makeInteractive(voucherElement);
            
            // åŠ¨æ€æ¶ˆæ¯ä½¿ç”¨å½“å‰è¯­è¨€å’Œè´§å¸ç¬¦å·
            const typeInCurrentLang = data['type_' + currentLanguage] || data.type;
            showMessage(getI18nText('msg_upload_success', id, data.amount.toFixed(2), typeInCurrentLang), 'success');

            // ç§»é™¤ç”»å¸ƒä¸­å¤®çš„æç¤ºæ–‡æœ¬
            const hint = canvasArea.querySelector('.pointer-events-none');
            if (hint) hint.remove();
            
            // è°ƒæ•´ç”»å¸ƒé«˜åº¦
            updateCanvasHeight();

            return voucherElement;
        }
        
        // --- OCR æ ¸å¿ƒé€»è¾‘ (ä¸å˜) ---

        /**
         * è°ƒç”¨ Gemini API è¿›è¡Œ OCR è¯†åˆ«å’Œåˆ†ç±»
         * @param {string} base64Image - ç¥¨æ®å›¾åƒçš„ Base64 å­—ç¬¦ä¸²
         * @param {string} mimeType - å›¾åƒçš„ MIME ç±»å‹
         * @returns {Promise<Object>} åŒ…å«é‡‘é¢ã€æ—¥æœŸã€ç±»åˆ«ç­‰çš„ JSON å¯¹è±¡
         */
        async function callGeminiOCR(base64Image, mimeType) {
            const systemInstruction = "ä½ æ˜¯ä¸€åä¸“ä¸šçš„è´¢åŠ¡åŠ©ç†ã€‚åˆ†ææä¾›çš„ç¥¨æ®æˆ–å‘ç¥¨å›¾åƒã€‚æå–æ€»é‡‘é¢ (Amount), äº¤æ˜“æ—¥æœŸ (Date), ç®€è¦è´¹ç”¨æè¿° (Desc), å¼€ç¥¨æ–¹åç§° (Issuer), å’Œç¨é¢ (Tax)ã€‚ç„¶åï¼Œæ ¹æ®è´¹ç”¨æ€§è´¨ï¼Œå°†è´¹ç”¨å½’ç±»ä¸ºä»¥ä¸‹äº”ä¸ªç±»åˆ«é”®ä¹‹ä¸€ï¼š'traffic', 'dining', 'accommodation', 'office', æˆ– 'other'ã€‚æ‰€æœ‰é‡‘é¢åº”ä¿ç•™ä¸¤ä½å°æ•°ã€‚æ—¥æœŸæ ¼å¼åº”ä¸º YYYY-MM-DDã€‚è¯·ä»¥ JSON æ ¼å¼è¾“å‡ºç»“æœï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„æ–‡æœ¬æˆ–è§£é‡Šã€‚";
            const userQuery = "è¯·è¯†åˆ«è¿™å¼ å‘ç¥¨/ç¥¨æ®çš„å…³é”®ä¿¡æ¯å¹¶è¿›è¡Œåˆ†ç±»ã€‚";
            const categoryKeys = Object.keys(CATEGORY_MAP).join("', '");
            
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userQuery },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64Image
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "amount": { "type": "NUMBER", "description": "Total expense amount, formatted as a number (e.g., 120.50)." },
                            "date": { "type": "STRING", "description": "Transaction date, formatted as YYYY-MM-DD (e.g., 2025-06-15)." },
                            "category": { "type": "STRING", "enum": Object.keys(CATEGORY_MAP), "description": `The expense category key: one of '${categoryKeys}'.` },
                            "desc": { "type": "STRING", "description": "A brief, one-sentence summary of the expense." },
                            "issuer": { "type": "STRING", "description": "The name of the company or entity that issued the voucher/invoice." },
                            "tax": { "type": "NUMBER", "description": "The tax or VAT amount, formatted as a number. Use 0.00 if not found." }
                        },
                        required: ["amount", "date", "category", "desc", "issuer", "tax"]
                    }
                }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            const response = await fetchWithRetry(API_URL, options);
            const result = await response.json();

            const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!jsonText) {
                throw new Error("OCR ç»“æœä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚");
            }
            
            // è§£æ JSON å­—ç¬¦ä¸²
            const parsedJson = JSON.parse(jsonText);
            return parsedJson;
        }

        // --- æ–‡ä»¶ä¸Šä¼ å’Œå¤„ç†äº‹ä»¶ (ä¸å˜) ---
        
        // è§¦å‘éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†
        document.getElementById('upload-btn').addEventListener('click', () => {
            document.getElementById('file-upload').click();
        });

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        document.getElementById('file-upload').addEventListener('change', handleFileUpload);

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†å‡½æ•°
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                showMessage(getI18nText('msg_upload_fail', 'è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ã€‚'), 'error');
                return;
            }

            // 1. UI æç¤ºåŠ è½½ä¸­
            const originalText = document.getElementById('upload-btn').innerHTML;
            const spinnerHtml = `<div class="spinner"></div>`;
            document.getElementById('upload-btn').innerHTML = `${spinnerHtml} ${getI18nText('msg_upload_start').split(' ')[2]}`;
            document.getElementById('upload-btn').disabled = true;

            try {
                // 2. è½¬æ¢ Base64
                const base64Image = await getBase64(file);
                const mimeType = file.type;

                // 3. è°ƒç”¨ Gemini OCR API
                const ocrResult = await callGeminiOCR(base64Image, mimeType);

                // 4. æ˜ å°„å¹¶æ·»åŠ ç¥¨æ®
                const voucherData = mapOcrResultToVoucherData(ocrResult);
                addVoucher(voucherData);

            } catch (error) {
                console.error('OCR Process Error:', error);
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                const errorMessage = error.message.includes("API call failed") ? 
                                    getI18nText('msg_upload_fail', 'æ¨¡å‹æœåŠ¡å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚') :
                                    getI18nText('msg_upload_fail', error.message);
                showMessage(errorMessage, 'error', 5000);
            } finally {
                // 5. æ¢å¤æŒ‰é’®çŠ¶æ€
                document.getElementById('upload-btn').innerHTML = originalText;
                document.getElementById('upload-btn').disabled = false;
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œç¡®ä¿ä¸‹æ¬¡changeäº‹ä»¶èƒ½è§¦å‘
                event.target.value = null; 
            }
        }


        // --- ä¾§è¾¹æ å’Œè¯¦æƒ…åŠŸèƒ½ ---

        // å­˜å‚¨å½“å‰é€‰ä¸­çš„ç¥¨æ®ID
        let selectedVoucherId = null;

        function showVoucherDetails(voucherElement) {
            // æ¸…é™¤ä¸Šä¸€ä¸ªé€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.voucher.selected').forEach(el => el.classList.remove('selected'));

            // è®¾ç½®æ–°é€‰ä¸­çŠ¶æ€
            voucherElement.classList.add('selected');
            selectedVoucherId = voucherElement.dataset.id;
            
            const data = voucherElement.dataset;
            
            // ä½¿ç”¨ parseFloat ç¡®ä¿é‡‘é¢æ•°æ®æ­£ç¡®ï¼Œå³ä½¿ dataset å­˜å‚¨çš„æ˜¯å­—ç¬¦ä¸²
            const amount = parseFloat(data.amount) || 0;
            const tax = parseFloat(data.tax) || 0;

            // æ ¹æ®å½“å‰è¯­è¨€è·å–ç¿»è¯‘æ•°æ®
            const type = data['type_' + currentLanguage] || data.type;
            const desc = data['desc_' + currentLanguage] || data.desc;
            const issuer = data['issuer_' + currentLanguage] || data.issuer;

            const html = `
                <div class="space-y-3 p-2 bg-gray-50 rounded-lg">
                    <div class="font-bold text-lg text-gray-800">${getI18nText('msg_voucher')} #${data.id}</div>
                    
                    <div class="flex justify-between py-1 border-b">
                        <span class="text-gray-500">${getI18nText('detail_amount')}</span>
                        <!-- ä½¿ç”¨ currentCurrencySymbol æ›¿æ¢ Â¥ -->
                        <span class="font-bold text-xl text-red-600">${currentCurrencySymbol}${amount.toFixed(2)}</span>
                    </div>

                    <div class="flex justify-between">
                        <span class="text-gray-500">${getI18nText('detail_type')}</span>
                        <span class="font-semibold text-gray-700">${type}</span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="text-gray-500">${getI18nText('detail_date')}</span>
                        <span class="font-semibold text-gray-700">${data.date}</span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="text-gray-500">${getI18nText('detail_summary')}</span>
                        <span class="font-semibold text-gray-700 max-w-[150px] truncate">${desc}</span>
                    </div>

                    <div class="flex justify-between border-t pt-3">
                        <span class="text-gray-500">${getI18nText('detail_issuer')}</span>
                        <span class="text-sm text-gray-600">${issuer || 'N/A'}</span>
                    </div>

                    <div class="flex justify-between">
                        <span class="text-gray-500">${getI18nText('detail_tax')}</span>
                        <!-- ä½¿ç”¨ currentCurrencySymbol æ›¿æ¢ Â¥ -->
                        <span class="text-sm text-gray-600">${currentCurrencySymbol}${tax.toFixed(2)}</span>
                    </div>

                    <div class="pt-4">
                        <button class="w-full bg-red-100 text-red-700 font-semibold py-2 rounded-lg hover:bg-red-200" onclick="removeVoucher(${data.id})">
                            ${getI18nText('btn_remove')}
                        </button>
                    </div>
                </div>
            `;

            detailsContent.innerHTML = html;
            sidebar.classList.add('open');
        }

        // æ¨¡æ‹Ÿç§»é™¤ç¥¨æ®åŠŸèƒ½
        function removeVoucher(id) {
            const voucher = document.getElementById(`voucher-${id}`);
            if (voucher) {
                voucher.remove();
                showMessage(`${getI18nText('msg_voucher')} #${id} ${getI18nText('btn_remove').split(' ')[0]}`, 'error');
            }
            // å…³é—­ä¾§è¾¹æ 
            document.getElementById('close-sidebar-btn').click(); 
            updateCanvasHeight(); // ç§»é™¤åæ›´æ–°ç”»å¸ƒé«˜åº¦
        }
        // å°† removeVoucher æš´éœ²ç»™å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿ HTML èƒ½å¤Ÿè°ƒç”¨
        window.removeVoucher = removeVoucher;

        // å…³é—­ä¾§è¾¹æ 
        document.getElementById('close-sidebar-btn').addEventListener('click', () => {
            sidebar.classList.remove('open');
            selectedVoucherId = null;
            document.querySelectorAll('.voucher.selected').forEach(el => el.classList.remove('selected'));
            detailsContent.innerHTML = `<p class="text-gray-500 text-center pt-8">${getI18nText('sidebar_hint')}</p>`;
        });

        // --- æ‹–æ‹½å’Œæ—‹è½¬é€»è¾‘ (ä¸å˜) ---
        let activeVoucher = null;
        let isDragging = false; 
        let xOffset = 0, yOffset = 0;

        function dragStart(e) {
            let target = e.target.closest('.voucher');
            if (!target) return;
            
            isDragging = false; 
            activeVoucher = target;
            activeVoucher.classList.add('selected'); 

            // è·å–ç¥¨æ®ç›¸å¯¹äºç”»å¸ƒçš„ä½ç½®
            const voucherLeft = activeVoucher.offsetLeft;
            const voucherTop = activeVoucher.offsetTop;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            // è®¡ç®—é¼ æ ‡/è§¦æ‘¸ç‚¹ä¸ç¥¨æ®å·¦ä¸Šè§’çš„åç§»é‡
            const canvasRect = canvasArea.getBoundingClientRect();
            const scrollLeft = canvasArea.scrollLeft;
            const scrollTop = canvasArea.scrollTop;

            xOffset = clientX - (canvasRect.left + voucherLeft - scrollLeft);
            yOffset = clientY - (canvasRect.top + voucherTop - scrollTop);


            canvasArea.addEventListener('mousemove', drag, false);
            canvasArea.addEventListener('mouseup', dragEnd, false);
            canvasArea.addEventListener('touchmove', drag, false);
            canvasArea.addEventListener('touchend', dragEnd, false);
        }

        function drag(e) {
            if (!activeVoucher) return;
            e.preventDefault();
            
            // åŒºåˆ†æ‹–æ‹½å’Œç‚¹å‡»
            if (!isDragging) {
                // åªæœ‰ç§»åŠ¨è¶…è¿‡ä¸€å®šé˜ˆå€¼æ‰ç®—æ‹–æ‹½
                isDragging = true; 
                activeVoucher.classList.add('cursor-grabbing');
            }

            const canvasRect = canvasArea.getBoundingClientRect();
            const scrollLeft = canvasArea.scrollLeft;
            const scrollTop = canvasArea.scrollTop;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            // è®¡ç®—æ–°ä½ç½®ï¼ˆç›¸å¯¹äºç”»å¸ƒçš„å·¦ä¸Šè§’ï¼Œå¹¶è€ƒè™‘æ»šåŠ¨æ¡ä½ç½®ï¼‰
            let newX = clientX - canvasRect.left + scrollLeft - xOffset;
            let newY = clientY - canvasRect.top + scrollTop - yOffset;
            
            // è¾¹ç•Œé™åˆ¶
            newX = Math.max(0, newX);
            newY = Math.max(0, newY); 

            activeVoucher.style.left = `${newX}px`;
            activeVoucher.style.top = `${newY}px`;
            
            updateCanvasHeight(); 
        }

        function dragEnd(e) {
            if (!activeVoucher) return;
            activeVoucher.classList.remove('cursor-grabbing');

            // å¦‚æœä¸æ˜¯æ‹–æ‹½æ“ä½œ (isDraggingä¸ºfalse)ï¼Œåˆ™è§†ä¸ºå•å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºè¯¦æƒ…
            if (!isDragging) {
                showVoucherDetails(activeVoucher);
            } else {
                // å¦‚æœæ˜¯æ‹–æ‹½ç»“æŸï¼Œå–æ¶ˆé€‰ä¸­çŠ¶æ€
                activeVoucher.classList.remove('selected');
                // æ‹–æ‹½ç»“æŸåï¼Œé‡æ–°è®¡ç®—ç”»å¸ƒé«˜åº¦ä»¥é€‚åº”å…ƒç´ 
                updateCanvasHeight(); 
            }

            activeVoucher = null;
            isDragging = false;

            canvasArea.removeEventListener('mousemove', drag, false);
            canvasArea.removeEventListener('mouseup', dragEnd, false);
            canvasArea.removeEventListener('touchmove', drag, false);
            canvasArea.removeEventListener('touchend', dragEnd, false);
        }
        
        // åŠ¨æ€è°ƒæ•´ç”»å¸ƒé«˜åº¦ä»¥é€‚åº”æ‰€æœ‰ç¥¨æ®
        function updateCanvasHeight() {
            const vouchers = document.querySelectorAll('.voucher');
            if (vouchers.length === 0) {
                // å¦‚æœæ²¡æœ‰ç¥¨æ®ï¼Œé‡ç½®ä¸ºæœ€å°é«˜åº¦
                canvasArea.style.height = parseFloat(getComputedStyle(canvasArea).minHeight) + 'px';
                return;
            }

            let maxBottom = 0; 
            const minHeight = parseFloat(getComputedStyle(canvasArea).minHeight);
            const padding = 60; // åº•éƒ¨é¢„ç•™æ›´å¤šç©ºé—´

            vouchers.forEach(voucher => {
                const bottom = voucher.offsetTop + voucher.offsetHeight + padding;
                maxBottom = Math.max(maxBottom, bottom);
            });

            // ç¡®ä¿å†…å®¹é«˜åº¦è‡³å°‘æ˜¯ minHeight
            const finalHeight = Math.max(maxBottom, minHeight);
            
            // åªæœ‰å½“è®¡ç®—å‡ºçš„é«˜åº¦å¤§äºå½“å‰è®¾ç½®çš„é«˜åº¦æ—¶æ‰æ›´æ–°ï¼Œé¿å…é—ªçƒ
            if (finalHeight > canvasArea.clientHeight) {
                canvasArea.style.height = `${finalHeight}px`;
            }
        }
        
        // æ—‹è½¬åŠŸèƒ½ (åŒå‡»æ¨¡æ‹Ÿ)
        function rotateVoucher(e) {
            if (e.target.closest('.voucher')) {
                const voucher = e.target.closest('.voucher');
                const currentTransform = voucher.style.transform || 'rotate(0deg)';
                const match = currentTransform.match(/rotate\(([-]?\d+)/);
                let currentRotation = match ? parseInt(match[1]) : 0;
                
                // æ¯æ¬¡æ—‹è½¬ 90 åº¦
                currentRotation = (currentRotation + 90) % 360;
                voucher.style.transform = `rotate(${currentRotation}deg)`;
                showMessage(`${getI18nText('msg_voucher')} #${voucher.dataset.id} ${getI18nText('msg_rotated')}`, 'info', 1000);
                e.stopPropagation(); // é˜»æ­¢åŒå‡»è§¦å‘å…¶ä»–äº‹ä»¶
            }
        }

        function makeInteractive(el) {
            el.addEventListener('mousedown', dragStart, false);
            el.addEventListener('touchstart', dragStart, false);
            el.addEventListener('dblclick', rotateVoucher); // åŒå‡»æ—‹è½¬
        }
        
        // ç‚¹å‡»ç”»å¸ƒç©ºç™½åŒºåŸŸå–æ¶ˆé€‰ä¸­
        canvasArea.addEventListener('click', (e) => {
            if (e.target === canvasArea || e.target.id === 'canvas-hint') {
                document.getElementById('close-sidebar-btn').click();
            }
        });


        // --- æ™ºèƒ½å¸é™„/å¯¹é½é€»è¾‘ (ä¸å˜) ---
        document.getElementById('align-btn').addEventListener('click', () => {
            const vouchers = Array.from(document.querySelectorAll('.voucher'));
            if (vouchers.length === 0) {
                showMessage(getI18nText('msg_no_vouchers'), 'info');
                return;
            }

            // æ¸…é™¤é€‰ä¸­çŠ¶æ€å’Œä¾§è¾¹æ 
            document.getElementById('close-sidebar-btn').click();

            const layoutMode = document.getElementById('layout-mode-select').value;
            let sortedVouchers = [...vouchers]; // å¤åˆ¶ä¸€ä»½ç”¨äºæ’åº

            if (layoutMode === 'DateGroup') {
                // æŒ‰æ—¥æœŸå€’åº (æœ€æ–°çš„åœ¨æœ€å‰)
                sortedVouchers.sort((a, b) => b.dataset.date.localeCompare(a.dataset.date));
                showMessage(getI18nText('msg_align_date'), 'success');
            } else if (layoutMode === 'CategoryGroup') {
                // æŒ‰ç±»åˆ«æ’åºï¼Œç±»åˆ«å†…æŒ‰é‡‘é¢å€’åº
                sortedVouchers.sort((a, b) => {
                    const categoryA = a.dataset.category;
                    const categoryB = b.dataset.category;
                    const amountA = parseFloat(a.dataset.amount);
                    const amountB = parseFloat(b.dataset.amount);

                    if (categoryA < categoryB) return -1;
                    if (categoryA > categoryB) return 1;
                    return amountB - amountA; // ç±»åˆ«å†…ï¼Œé‡‘é¢é«˜çš„åœ¨å‰
                });
                showMessage(getI18nText('msg_align_category'), 'success');
            } else {
                // é»˜è®¤ A4 å¯¹é½ (ä¸æ’åº)
                showMessage(getI18nText('msg_align_a4'), 'success');
            }
            
            // --- åº”ç”¨ç½‘æ ¼å¸ƒå±€åˆ° sortedVouchers ---
            const padding = 20;
            const voucherGap = 20; // ç¥¨æ®é—´è·
            let startX = padding;
            let startY = padding;
            const maxColumns = 4; 
            let currentColumn = 0;
            let maxVoucherHeight = 0; 
            
            let previousGroupKey = null;

            sortedVouchers.forEach((voucher) => {
                let currentGroupKey;
                if (layoutMode === 'DateGroup') {
                    currentGroupKey = voucher.dataset.date.substring(0, 7); // æŒ‰å¹´/æœˆåˆ†ç»„
                } else if (layoutMode === 'CategoryGroup') {
                    currentGroupKey = voucher.dataset.category;
                } else {
                    currentGroupKey = 'default'; // A4 æ¨¡å¼
                }
                
                // æ£€æŸ¥æ˜¯å¦å¼€å§‹æ–°åˆ†ç»„ï¼Œå¹¶æ·»åŠ æ›´å¤§çš„å‚ç›´ç©ºé—´
                if (previousGroupKey !== null && currentGroupKey !== previousGroupKey) {
                    // æ¢è¡Œå¹¶å¢åŠ é¢å¤–çš„ç»„é—´è·
                    currentColumn = 0;
                    startY += maxVoucherHeight + voucherGap * 3; 
                    startX = padding;
                    maxVoucherHeight = 0;
                }

                // ç§»é™¤æ—‹è½¬ä»¥ä¿è¯æ•´é½æ’ç‰ˆ
                voucher.style.transform = 'rotate(0deg)';
                
                const width = voucher.offsetWidth;
                const height = voucher.offsetHeight;

                // å‡è®¾ç”»å¸ƒæœ€å¤§å®½åº¦ä¸º 1200px (max-w-7xl æ¥è¿‘)
                const canvasMaxWidth = 1200; 

                if (currentColumn >= maxColumns || (startX + width + padding) > canvasMaxWidth) {
                    // å†…éƒ¨æ¢è¡Œ
                    currentColumn = 0;
                    startY += maxVoucherHeight + voucherGap;
                    startX = padding;
                    maxVoucherHeight = 0;
                }

                // è®¾ç½®æ–°ä½ç½®
                voucher.style.left = `${startX}px`;
                voucher.style.top = `${startY}px`;

                // æ›´æ–°ä¸‹ä¸€å¼ ç¥¨æ®çš„èµ·å§‹ä½ç½®å’Œç»„ä¿¡æ¯
                startX += width + voucherGap;
                currentColumn++;
                maxVoucherHeight = Math.max(maxVoucherHeight, height);
                previousGroupKey = currentGroupKey;
            });
            
            // è‡ªåŠ¨è°ƒæ•´ç”»å¸ƒé«˜åº¦ï¼Œç¡®ä¿æ‰€æœ‰å¯¹é½çš„ç¥¨æ®éƒ½å¯è§
            updateCanvasHeight();

        });

        // --- å¯¼å‡ºåŠŸèƒ½æ¨¡æ‹Ÿ (ä¸å˜) ---
        document.getElementById('export-btn').addEventListener('click', () => {
            const count = document.querySelectorAll('.voucher').length;
            if (count === 0) {
                showMessage(getI18nText('msg_export_error'), 'error');
                return;
            }
            showMessage(getI18nText('msg_export_in_progress', count), 'info', 2000);
            setTimeout(() => {
                showMessage(getI18nText('msg_export_success'), 'success', 5000);
            }, 2500);
        });
        
        // åˆå§‹åŒ–æ—¶æ·»åŠ æ¨¡æ‹Ÿç¥¨æ®
        window.onload = () => {
            // 1. è®¾ç½®é»˜è®¤è¯­è¨€å¹¶ç¿»è¯‘ UI
            translateUI(currentLanguage);

            // 2. åˆå§‹åŠ è½½ 20 å¼ æ¨¡æ‹Ÿç¥¨æ®
            for (let i = 0; i < 20; i++) {
                const data = MOCK_VOUCHER_TYPES[i % MOCK_VOUCHER_TYPES.length];
                // é‡æ–°è®¡ç®— x/y åæ ‡ä»¥ä¿è¯æ•£å¼€æ•ˆæœ
                const x = Math.random() * (canvasArea.clientWidth - 160); 
                const y = Math.random() * (canvasArea.clientHeight - 90);
                const rotation = Math.floor(Math.random() * 60) - 30;

                const element = createVoucherElement(i + 1, data, x, y, rotation);
                canvasArea.appendChild(element);
                makeInteractive(element);
                voucherCount = i + 1;
            }

            showMessage(getI18nText('msg_welcome'), 'info', 8000);
            
            // ç§»é™¤ç”»å¸ƒä¸­å¤®çš„æç¤ºæ–‡æœ¬
            const hint = canvasArea.querySelector('.pointer-events-none');
            if (hint) hint.remove();
            
            // é¦–æ¬¡åŠ è½½åè°ƒæ•´ç”»å¸ƒé«˜åº¦
            updateCanvasHeight();
        };

    </script>
    </body>
    </html>
